== Web サービスの作り方

ここからが，本書第三部の内容になる．

これまでのセクションでは，仮想サーバーをクラウド上に起動し，そこで計算を走らせる方法について解説をしてきた．
最初に， EC2 上に個人で使用するためのサーバーを立ち上げ，機械学習の計算を実践した．
また，大規模な計算システムを構築するための初歩として， ECS と Docker を使ったクラスターを作成する方法を解説した．
これまで紹介したクラウドの利用は，個人としての用途にフォーカスしていた．
一方で，広く一般に使ってもらえるような計算サービス・データベースを提供する，というのもクラウドの重要な役割として挙げられる．

第三部では，前回までとは少し方向性を変え，どのようにしてクラウド上にアプリケーションを展開し，広く一般の人に使ってもらうか，という点を講義したいと思う．
これを通じて，どのようにして世の中のウェブサービスができ上がっているのかを知り，さらにどうやって自分でそのようなアプリケーションをゼロから構築するのか，という点を学んでもらう．
その過程で， Serverless アーキテクチャという最新のクラウド設計手法を解説する．

=== ウェブサービスの仕組み -- Twitter を例に

あなたがパソコンやスマートフォンから Twitter, Facebook, YouTube などのウェブサービスにアクセスしたとき，
実際にどのようなことが行われ，コンテンツが提示されているのだろうか？

HTTP を通じたサーバーとクライアントのデータのやり取りは，すでに知っている読者も多いだろうし，逆にすべて解説しようとすると紙面が足りないので，ここではエッセンスの説明のみにとどめる．
以降では https://twitter.com[Twitter] を具体例として，背後にあるサーバーとクライアントの間の通信を概説しよう．
概念図としては <<fig:web_server>> のような通信がクライアントとサーバーの間で行われていることになる．

[[fig:web_server]]
.クライアントと Web サーバーの通信の概念図
image::imgs/web_server.png[web_server, 700, align="center"]

前提として，クライアントとサーバーの通信は **HTTP (Hypertext Transfer Protocol)** を使って行われる．
また，最近では，暗号化された HTTP である **HTTPS** を用いることがスタンダードになってきている．
第一のステップとして，クライアントは HTTP(S) 通信によってサーバーから静的なコンテンツを取得する．
静的なコンテンツとは， **HTML (Hyptertext Markup Language)** で記述されたウェブページの文書本体， **CSS (Cascading Style Sheets)** で記述されたページのデザインやレイアウトファイル，そして **JavaScript (JS)** で記述されたページの動的な挙動を定義したプログラム，が含まれる．
Twitter を含む現代的なウェブアプリケーションの設計では，この静的なファイル群はページの”枠”を定義するだけで，中身となるコンテンツ (例: ツイートの一覧) は別途 **API (Application Programming Interface)** によって取得されなければならない．
そこで，クライアントは先のステップで取得された JavaScript で定義されたプログラムに従って，サーバーに API を送信し，ツイートや画像データを取得する．
この際，テキストデータのやり取りには **JSON (JavaScript Object Notation)** というフォーマットが用いられることが多い．
画像や動画などのコンテンツも同様にAPIにより取得される．
このようにして取得されたテキストや画像が，HTMLの文書に埋め込まれることで，最終的にユーザーに提示されるページが完成するのである．
また，新しいツイートを投稿するときにも，クライアントから API を通じてサーバーのデータベースにデータが書き込まれる．

[[sec_rest_api]]
=== REST API

API (Application Programming Interface) とはこれまで何度も出てきた言葉であるが，ここではよりフォーマルな定義付けを行う．
API とはあるソフトウェア・アプリケーションが，外部のソフトウェアに対してコマンドやデータをやり取りするための媒介の一般的総称である．
とくに，ウェブサービスの文脈では，サーバーが外界に対して提示しているコマンドの一覧のことを意味する．
クライアントは，提示されている API から適切なコマンドを使うことによって，所望のデータを取得したり，あるいはサーバーにデータを送信したりする．

とくに，ウェブの文脈では **REST (Representational State Transfer)** とよばれる設計思想に基づいた API が現在では最も一般的に使われている．
REST の設計指針に従った API のことを **REST API** あるいは **RESTful API** とよんだりする．

REST API は， <<rest_api>> に示したような **Method** と **URI (Universal Resource Identifier)** の組からなる．

[[rest_api]]
.REST API
image::imgs/rest_api.png[rest_api, 700, align="center"]

Method (メソッド) とは，どのような操作を行いたいかを抽象的に表す，**"動詞"** として捉えることができる．
メソッドには HTTP 規格で定義された9個の動詞 (verb) を使用することができる．
この中でも， `GET`, `POST`, `PUT`, `PATCH`, `DELETE` の5個が最も頻繁に使用される (<<tab:rest_api_methods>>)．
この5つのメソッドによる操作を総称して **CRUD** (create, read, update, and delete) とよぶ．

[[tab:rest_api_methods]]
[cols="1,3", options="header"]
.REST API Methods
|===
|メソッド
|意図される動作

|GET
|要素を取得する

|POST
|新しい要素を作成する

|PUT
|既存の要素を新しい要素と置き換える

|PATCH
|既存の要素の一部を更新する

|DELETE
|要素を削除する
|===

一方， URI は操作が行われる対象，すなわち **"目的語"** を表す．
ウェブの文脈では操作が行われる対象のことをしばしば **リソース** とよぶ．
URI は多くの場合 http または https から始まるウェブサーバーのアドレスから始まり， / (スラッシュ) 以降に所望のリソースのパスが指定される．
<<rest_api>> の例で言えば， `https://api.twitter.com` というアドレスの `/1.1/status/home_timeline` というリソースを取得 (GET) せよ，という意味になる
(なお，ここで `1.1` という数字は API のバージョンを示している)．
この API リクエストによって，ユーザーのホームのタイムラインのツイートの一覧が取得される．

[TIP]
====
REST API のメソッドには， <<tab:rest_api_methods>> で挙げたもの以外に， HTTP プロトコルで定義されているｊｐぁのメソッド (OPTIONS, TRACE など) を用いることもできるが，あまり一般的ではない．

また，これらのメソッドだけでは動詞として表現しきれないこともあるが， URI の名前でより意味を明確にすることもある．
メソッドの使い方も，要素を削除する際は必ず `DELETE` を使わなければならない，という決まりもなく，たとえば， Twitter API でツイートを消す API は `POST statuses/destroy/:id` で定義されている．
最終的には，各ウェブサービスが公開している API ドキュメンテーションを読んで，それぞれの API がどんな操作をするのかを調べる必要がある．
====

=== Twitter API

もう少し具体的にウェブサービスのAPIを体験する目的で，ここでは Twitter のAPIを見てみよう．

Twitter が提供している API の一覧は
https://developer.twitter.com/en/docs/api-reference-index[Twitter の Developer Documentation]
で見ることができる．
いくつかの代表的な API を <<tab_twitter_api>> にまとめた．

[[tab_twitter_api]]
[cols="1,1"]
.Twitter API
|===
|`GET /statuses/home_time_line`
|ホームのタイムラインのツイートの一覧を取得する．

|`GET /statuses/show/:id`
|`:id` で指定されたツイートの詳細情報を取得する．

|`POST /statuses/update`
|新しいツイートを投稿する．

|`POST /statuses/retweet/:id`
|`:id` で指定されたツイートをリツイートする．

|`POST /favorites/create/:id`
|`:id` で指定されたツイートを"いいね"する．

|`POST /statuses/destroy/:id`
|`:id` で指定されたツイートを削除する．
|=== 

Twitter のアプリまたはウェブサイトを開くと，背後では上記のような API が使用され，その結果ウェブページがレンダリングされている．
また， Twitter 上でボット (bot) を作るときは，これらの API リクエストを自動で実行するプログラムを記述することででき上がっている．

このように， API はあらゆるウェブサービスを作るうえで一番基礎となる要素である．
次からの章では本章で紹介した用語が何度も出てくるので，頭の片隅に置いたうえで読み進めていただきたい．

