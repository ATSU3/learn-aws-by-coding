== Appendix

[[aws_secrets]]
=== AWS のシークレットキーの作成

AWS シークレットキーとは， AWS CLI や AWS CDK から AWS の API を操作する際に，ユーザー認証を行うための鍵のことである．
AWS CLI/CDK を使うには，最初にシークレットキーを発行する必要がある．
AWS シークレットキーの詳細は https://docs.aws.amazon.com/general/latest/gr/aws-sec-cred-types.html[公式ドキュメンテーション] を参照．

. AWS コンソールにログインする．
. 画面右上のアカウント名をクリックし，表示されるプルダウンメニューから "My Security Credentials" を選択 (<<fig:aws_secret_key_1>>)
. "Access keys for CLI, SDK, & API access" の下にある "Create accesss key" のボタンをクリックする (<<fig:aws_secret_key_2>>)
. 表示された Access key ID, Secret access key を記録しておく (画面を閉じると以降は表示されない)．
. 鍵を忘れてしまった場合などは，同じ手順で再発行が可能である．
. 発行したシークレットキーは， `~/.aws/credentials` のファイルに書き込むか，環境変数に設定するなどして使う (詳しくは <<aws_cli_install>>)．

[[fig:aws_secret_key_1]]
.AWS シークレットキーの発行1
image::imgs/aws_secret_key_1.png[aws_secret_key_1, 400, align="center"]

[[fig:aws_secret_key_2]]
.AWS シークレットキーの発行2
image::imgs/aws_secret_key_2.png[aws_secret_key_2, 700, align="center"]

[WARNING]
====
**AWS Educate Starter Account** を用いている場合は，以下の手順でシークレットキーを確認する．

- AWS Educate のコンソール画面から， `vocareum` のコンソールに移動する (<<fig:vocareum_console>>)．
- `Account Details` をクリックし，続いて `AWS CLI: Show` をクリックする．
- `aws_access_key_id`, `aws_secret_access_key`, `aws_session_token` が表示される (<<fig:vocareum_secret>>)．
ここで表示された内容を `~/.aws/credentials` にコピーする (<<aws_cli_install>> 参照)．
`aws_session_token` の箇所も漏らさずコピーすること．
- 続いて， `~/.aws/config` というファイルを用意し，次の内容を書き込む．
現時点では AWS Starter Account は `us-east-1` リージョンでしか利用できないためである．
[source, bash]
----
[default]
region = us-east-1
output = json
----
- 上記の説明ではプロファイル名が `default` となっていたが，これは自分の好きな名前に変更しても良い．
`default` 以外の名前を使用する場合は，コマンドを実行する際にプロファイル名を指定する必要がある (<<aws_cli_install>>)．


[[fig:vocareum_console]]
.vocareum コンソール
image::imgs/vocareum_console.png[vocareum console, 700, align="center"]

[[fig:vocareum_secret]]
.vocareum から AWS シークレットキーの発行
image::imgs/vocareum_secret.png[vocareum secret, 700, align="center"]
====


[[aws_cli_install]]
=== AWS CLI のインストール

読者のために，執筆時点におけるインストールの手順 (Linux 向け) を簡単に記述する．
将来のバージョンでは変更される可能性があるので，常に https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html[公式のドキュメンテーション] で最新の情報をチェックすることを忘れずに．

[source, bash]
----
$ curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
$ unzip awscliv2.zip
$ sudo ./aws/install
----

インストールできたか確認するため，以下のコマンドを打ってバージョン情報が出力されることを確認する．

[source, bash]
----
$ aws --version
----

インストールができたら，以下のコマンドにより初期設定を行う (https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html[参照])．

[source, bash]
----
$ aws configure
----

コマンドを実行すると， `AWS Access Key ID`, `AWS Secret Access Key` を入力するよう指示される．
シークレットキーの発行については <<aws_secrets>> を参照．
コマンドは加えて，`Default region name` を訊いてくる．
ここには自分の好きな地域 (例えば `ap-northeast-1` =東京リージョン) を指定すればよい．
最後の `Default output format` は `JSON` としておくとよい．

上記のコマンドを完了すると， `~/.aws/credentials` と `~/.aws/config`　という名前のファイルが生成されているはずである．
念の為，中身をしてみるとよい．

[source, bash]
----
$ cat ~/.aws/credentials
[default]
aws_access_key_id = XXXXXXXXXXXXXXXXXX
aws_secret_access_key = YYYYYYYYYYYYYYYYYYY

$ cat ~/.aws/config
[profile default]
region = ap-northeast-1
output = json
----

上記のような出力が得られるはずである．

`~/.aws/credentials` には認証鍵の情報が， `~/.aws/config` には AWS CLI の設定が記録されている．

デフォルトでは， `[default]` という名前でプロファイルが保存される．
いくつかのプロファイルを使い分けたければ， default の例に従って，例えば `[myprofile]` などという名前でプロファイルを追加すればよい．

AWS CLI でコマンドを打つときに，プロファイルを使い分けるには，

[source, bash]
----
$ aws s3 ls --profile myprofile
----

のように， `--profile` というオプションをつけてコマンドを実行する．

いちいち `--profile` オプションをつけるのが面倒だと感じる場合は， `AWS_PROFILE` という環境変数を設定するとよい．

[source, bash]
----
$ export AWS_PROFILE=myprofile
----

あるいは，認証情報などを環境変数に設定するテクニックもある．

[source, bash]
----
export AWS_ACCESS_KEY_ID=XXXXXX
export AWS_SECRET_ACCESS_KEY=YYYYYY
export AWS_DEFAULT_REGION=ap-northeast-1
----

上の環境変数は， `~/.aws/credentials` よりも高い優先度を持つので，環境変数が設定されていればそちらの情報が使用される (https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html[参照])．

[WARNING]
====
**AWS Educate Starter Account** は `us-east-1` のリージョンのみ利用可能である (執筆時点での情報)．
よって， AWS Educate Starter Account を使用している場合は， default region を `us-east-1` に設定する必要がある．
====

[[aws_cdk_install]]
=== AWS CDK のインストール

読者のために，執筆時点におけるインストールの手順 (Linux 向け) を簡単に記述する．
将来のバージョンでは変更される可能性があるので，常に https://docs.aws.amazon.com/cdk/latest/guide/getting_started.html[公式のドキュメンテーション] で最新の情報をチェックすることを忘れずに．

Node.js がインストールされていれば，基本的に以下のコマンドを実行すれば良い．

[source, bash]
----
$ sudo npm install -g aws-cdk
----

[NOTE]
====
本書のハンズオンはAWS CDK version 1.100.0 で開発した．
CDK は開発途上のライブラリなので，将来的にAPIが変更される可能性がある．
APIの変更によりエラーが生じた場合は， version 1.100.0 を使用することを推奨する．

[source, bash]
----
$ npm install -g aws-cdk@1.100
----
====

インストールできたか確認するため，以下のコマンドを打って正しくバージョンが表示されることを確認する．

[source, bash]
----
$ cdk --version
----

インストールができたら，以下のコマンドによりAWS側の初期設定を行う．これは一度実行すればOK．

[source, bash]
----
$ cdk bootstrap
----

[NOTE]
====
`cdk bootstrap` を実行するときは，AWSの認証情報とリージョンが正しく設定されていることを確認する．
デフォルトでは `~/.aws/config` にあるデフォルトのプロファイルが使用される．
デフォルト以外のプロファイルを用いるときは <<aws_cli_install>> で紹介したテクニックを使って切り替える．
====

[NOTE]
====
AWS CDK の認証情報の設定は AWS CLI と基本的に同じである．詳しくは <<aws_cli_install>> を参照．
====

[[venv_quick_guide]]
=== Python `venv` クイックガイド

他人からもらったプログラムで， numpy や scipy のバージョンが違う！などの理由で，プログラムが動かない，という経験をしたことがある人は多いのではないだろうか．
もし，自分の計算機の中に一つしか Python 環境がないとすると，プロジェクトを切り替えるごとに正しいバージョンをインストールし直さなければならず，これは大変な手間である．

コードのシェアをよりスムーズにするためには，ライブラリのバージョンはプロジェクトごとに管理されるべきである．
それを可能にするのが Python 仮想環境と呼ばれるツールであり， https://docs.python.org/3/tutorial/venv.html[venv], https://github.com/pyenv/pyenv[pyenv], https://docs.conda.io/en/latest/[conda] などがよく使われる．

そのなかでも， `venv` は Python に標準搭載されているので，とても便利である．
`pyenv` や `conda` は，別途インストールの必要があるが，それぞれの長所もある．

`venv` を使って仮想環境を作成するには，

[source, bash]
----
$ python -m venv .env
----

と実行する．
これにより `.env/` というディレクトリが作られ，このディレクトリに依存するライブラリが保存されることになる．

この新たな仮想環境を起動するには

[source, bash]
----
$ source .env/bin/activate
----

と実行する．

シェルのプロンプトに `(.env)` という文字が追加されていることを確認しよう (<<fig_venv_prompt>>)．
これが， "いまあなたは venv の中にいますよ" というしるしになる．

[[fig_venv_prompt]]
.venv を起動したときのプロンプト
image::imgs/venv_shell.png[venv shell, 500, align="center"]

仮想環境を起動すると，それ以降実行する `pip` コマンドは， `.env/` 以下にインストールされる．このようにして，プロジェクトごとに使うライブラリのバージョンを切り分けることができる．

Python では `requirements.txt` というファイルにに依存ライブラリを記述するのが一般的な慣例である．他人からもらったプログラムに， `requirements.txt` が定義されていれば，

[source, bash]
----
$ pip install -r requirements.txt
----

と実行することで，必要なライブラリをインストールし，瞬時に Python 環境を再現することができる．

[NOTE]
====
venv による仮想環境を保存するディレクトリの名前は任意に選べることができるが， `.env` という名前を用いるのが一般的である．
====

[[sec_handson_docker]]
=== ハンズオン実行用の Docker image の使い方

ハンズオンを実行するために必要な， Node.js, Python, AWS CDK などがインストールされた Docker image を用意した．
これを使用することで，自分のローカルマシンに諸々をインストールする必要なく，すぐにハンズオンのコードが実行できる．

[WARNING]
====
ハンズオンのいくつかのコマンドは Docker の外 = ローカルマシンのリアル環境で実行されなければならない．
それらについてはハンズオンの該当箇所に注意書きとして記してある．
====

Docker Image は https://hub.docker.com/repository/docker/tomomano/labc[Docker Hub] においてある．
Docker Image のビルドファイルは https://github.com/tomomano/learn-aws-by-coding/blob/main/docker/Dockerfile[こちら] にある．

次のコマンドで container を起動する．

[source, bash]
----
$ docker run -it tomomano/labc:latest
----

初回にコマンドを実行したときのみ， image が Docker Hub からダウンロード (pull) される．
二回目以降はローカルにダウンロードされた image が使用される．

container が起動すると，次のようなインタラクティブシェルが表示されるはずである (起動時に `-it` のオプションをつけたのがポイントである)．

[source]
----
root@aws-handson:~$
----

この状態で `ls` コマンドを打つと， `handson/` というディレクトリがあるはずである．
ここに `cd` する．

[souce, bash]
----
$ cd handson
----

すると，各ハンズオンごとのディレクトリが見つかるはずである．

あとは，ハンズオンごとにディレクトリを移動し，ハンズオンごとの virtualenv を作成し，スタックのデプロイを行えばよい (<<sec_handson_ec2_run>> など参照)．
ハンズオンごとに使用する依存ライブラリが異なるので，それぞれのハンズオンごとに virtualenv を作成するという設計になっている．

AWS の認証情報を設定することも忘れずに．
<<aws_cli_install>> で記述したように， `AWS_ACCESS_KEY_ID` などの環境変数を設定するのが簡単な方法である．
あるいは，**ローカルマシンの** `~/.aws/credentials` に認証情報が書き込まれているなら，このディレクトリを container に**マウント**することで，同じ認証ファイルを container 内部から参照することが可能である．
この選択肢を取る場合は，以下のコマンドで container を起動する．

[source, bash]
----
$ docker run -it -v ~/.aws:/root/.aws:ro docker.pkg.github.com/tomomano/learn-aws-by-coding/labc:latest
----

これにより，ローカルマシンの `~/.aws` を container の `/root/.aws` にマウントすることができる．
最後の `:ro` は read-only を意味する．
大切な認証ファイルが誤って書き換えられてしまわないように， read-only のフラグをつけることをおすすめする．

[TIP]
====
`/root/` が container 環境におけるホームディレクトリである．
ここで紹介した認証ファイルをマウントするテクニックは， SSH 鍵を container に渡すときなどにも使える．
====

